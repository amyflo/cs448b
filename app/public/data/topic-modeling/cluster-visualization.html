<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Basic D3 Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Import D3 library -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/pca-js@1.0.0/pca.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/ml-pca"></script>
    <!-- Import PCA library for PCA clustering visualization-->

    <style>
      /* Basic styles */
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      #chart {
        display: block;
        margin: 0 auto;
        border: 1px solid #ddd;
        /* background-color: #f9f9f9; */
        background-color: transparent;
        z-index: 1;
      }
      .tooltip {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        pointer-events: none;
        opacity: 0;
        z-index: 10;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <h1>Basic D3 Visualization</h1>
    <svg id="chart" width="800" height="600"></svg>
    <!-- Placeholder canvas -->
    <div id="tooltip" class="tooltip"></div>

    <script>
      // Log a simple message to confirm D3 is loaded
      console.log("D3 version:", d3.version);

      // Example: Select the SVG element and set its background color
      d3.select("#chart")
        .style("background-color", "transparent")
        .append("text") // Add a placeholder text to the canvas
        .attr("x", 400)
        .attr("y", 300)
        .attr("text-anchor", "middle")
        .attr("font-size", "24px")
        .attr("fill", "#555");

      // load topic assignment data and the topic reference data
      // (promise for waiting for both sets to load before moving on)
      Promise.all([
        d3.json("../top_topics_with_weights.json"),
        d3.json("../topics_NMF_15.json"),
        d3.json("../reduced-data.json"),
      ]).then(([assignedTopicsData, topicsRefData, reducedData]) => {
        console.log("Loaded Data: ", assignedTopicsData);
        console.log("Topic Ref Data: ", topicsRefData);

        // set width and height values
        const width = 800;
        const height = 600;

        // scale to cluster
        const xScale = d3
          .scaleLinear()
          .domain([
            d3.min(reducedData, (d) => d.x),
            d3.max(reducedData, (d) => d.x),
          ])
          .range([0, width]);

        const yScale = d3
          .scaleLinear()
          .domain([
            d3.min(reducedData, (d) => d.y),
            d3.max(reducedData, (d) => d.y),
          ])
          .range([height, 0]);

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // select the SVG element chart (because this is where I want to plot the circles in)
        // select the tooltip (should show up on mouseover)
        const svg = d3.select("#chart");
        const tooltip = d3.select("#tooltip");

        // for each letter, plot the points with the first and second principal components
        reducedData.forEach((point, index) => {
          const x = xScale(point.x);
          const y = yScale(point.y);
          console.log(`x: ${x}, y: ${y}`); // Log the scaled coordinates

          const post = assignedTopicsData[index];
          const firstLabel = topicsRefData[post.topics.first.topic].label;
          const secondLabal = topicsRefData[post.topics.second.topic].label;
          const topTopicIdx = post.topics.first.topic;
          const color = colorScale(topTopicIdx);
          svg
            .append("circle")
            .attr("cx", x) // access the x field of the current data point
            .attr("cy", y) // access the y field of the current data point
            .attr("r", 8)
            .attr("fill", color)
            .attr("opacity", 0.5)
            .on("mouseover", (event) => {
              console.log("Mouseover event triggered for post:", post.post_id);

              // Show the tooltip and position it near the circle
              tooltip.transition().duration(200).style("opacity", 1);
              tooltip
                .html(
                  `<strong>Post ID:</strong> ${post.post_id}<br><strong>Top 2 Topics:</strong> ${firstLabel} and ${secondLabal}`
                )
                .style("left", `${event.pageX + 10}px`)
                .style("top", `${event.pageY - 25}px`);
            })
            .on("mouseout", () => {
              console.log("Mouseout event triggered for post:", post.post_id);
              // Hide the tooltip when mouse is no longer over the circle
              tooltip.transition().duration(200).style("opacity", 0);
            });
        });
      });
    </script>
  </body>
</html>
